# ğŸ”¹ Ä°ÅŸlemci ve Test Dizini (Tam Yollar)
HOME_DIR = /home/kerim
TCORE_DIR = $(HOME_DIR)/tcore-rv32imc
ISA_TESTS_DIR = $(HOME_DIR)/riscv/tests/riscv-tests/isa
HEX_FILES = $(wildcard $(ISA_TESTS_DIR)/*.hex)

# ğŸ”¹ ModelSim/QuestaSim AyarlarÄ± (HÄ±zlandÄ±rma Ä°Ã§in Optimize Edildi)
INC_FILE = $(TCORE_DIR)/rtl/include/
SUPPRESS_CMD = -suppress vlog-2583 -suppress vopt-8386 -suppress vlog-2275 -svinputport=relaxed
VLOG_OPTS = -sv ${SUPPRESS_CMD} +acc=npr +incdir+${INC_FILE} -work $(WORK_DIR) -mfcu -quiet  # ğŸ”¥ HÄ±zlÄ± derleme!
VOPT_OPTS = -o $(OPTIMIZED_LIB) +acc=npr

# ğŸ”¹ SystemVerilog & Verilog Kaynak DosyalarÄ± (KlasÃ¶rler Yerine Sadece Dosyalar Dahil)
SV_SOURCES =  $(TCORE_DIR)/rtl/pkg/tcore_param.sv \
              $(wildcard $(TCORE_DIR)/rtl/core/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/core/branch_prediction/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/core/cache/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/core/mul_div/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/core/mul_div/wallace8x8/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/periph/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/ram/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/wrapper/*.sv) \
              $(wildcard $(TCORE_DIR)/rtl/wrapper/*.v)

# ğŸ”¹ Test Bench ve Wrapper
TB_FILE = $(TCORE_DIR)/rtl/tb/tb_wrapper.v
TOP_LEVEL = tb_wrapper
LIBRARY = work
VSIM = vsim
VLOG = vlog
VOPT = vopt
VLIB = vlib
WORK_DIR = work

# ğŸ”¹ Dump & Fetch Log DosyalarÄ±
FETCH_LOG = fetch_log.txt
PASS_FAIL_ADDR = pass_fail_addr.txt
CHECK_SCRIPT = $(TCORE_DIR)/check_pass_fail.py
DUMP_PARSER = $(TCORE_DIR)/dump_parser.py

# ğŸ”¹ RAM Ä°Ã§in Sabit Test YÃ¼kleme DosyasÄ±
MEM_FILE = $(TCORE_DIR)/coremark_baremetal_static.mem

# ğŸ”¹ SimÃ¼lasyon SÃ¼resi (Daha KÄ±sa SÃ¼re)
SIM_TIME = 20000ns  # ğŸ”¥ Daha kÄ±sa sÃ¼rede testleri bitir!

# ğŸ”¹ VarsayÄ±lan hedef (TÃ¼m testleri Ã§alÄ±ÅŸtÄ±r)
all: compile test_all

# ğŸ”¹ TÃ¼m Hex Testlerini **Paralel** Ã‡alÄ±ÅŸtÄ±r ve PASS/FAIL KontrolÃ¼ Yap
test_all: $(HEX_FILES)
	@echo "ğŸ”„ Running all RISC-V tests sequentially..."
	@rm -f test_results.txt sim_log.txt  # Ã–nceki testleri temizle
	@for hexfile in $(HEX_FILES); do \
		echo "â–¶ Running test with $$hexfile..."; \
		make -f makefile single_test TEST_FILE=$$hexfile; \
	done
	@echo "âœ… All tests completed! Check test_results.txt for results."

# ğŸ”¹ Tek Bir Testi Ã‡alÄ±ÅŸtÄ±r (SimÃ¼latÃ¶r Ã‡Ä±ktÄ±sÄ±nÄ± AyrÄ± Log'a Yaz, Test Ä°smini Dahil Et)
single_test:
	@echo "ğŸ” Running test: $(TEST_FILE)"
	@rm -f $(MEM_FILE)  # Ã–nceki RAM dosyasÄ±nÄ± temizle
	@cp "$(TEST_FILE)" "$(MEM_FILE)"  # RAM'e yeni test yÃ¼kle
	@make simulate > /dev/null 2>&1  # ğŸ”¥ SimÃ¼lasyonu sessiz Ã§alÄ±ÅŸtÄ±r!
	@python3 $(DUMP_PARSER) $(TEST_FILE:.hex=.dump) > /dev/null 2>&1  # ğŸ”¥ Dump iÅŸlemini sessiz yap
	@echo -n "[ $(notdir $(TEST_FILE)) ]: " >> test_results.txt  # ğŸ”¹ Test ismini ekle
	@python3 $(CHECK_SCRIPT) $(PASS_FAIL_ADDR) $(FETCH_LOG) | tee -a test_results.txt  # ğŸ”¹ SADECE PASS/FAIL EKLE

# ğŸ”¹ ModelSim/QuestaSim ile **Optimize EdilmiÅŸ** SimÃ¼lasyon Ã‡alÄ±ÅŸtÄ±rma
simulate: compile
	$(VSIM) -c $(LIBRARY).$(TOP_LEVEL) -do "run $(SIM_TIME); quit" -t ns -voptargs=+acc=npr

# ğŸ”¹ Derleme (Sadece DeÄŸiÅŸen Dosyalar Derlenecek)
$(WORK_DIR):
	$(VLIB) $(WORK_DIR)

compile: $(WORK_DIR)
	$(VLOG) $(VLOG_OPTS) $(SV_SOURCES) $(TB_FILE) $(DEFINE_MACROS)

# ğŸ”¹ Optimizasyon (Ä°steÄŸe BaÄŸlÄ±)
optimize: compile
	$(VOPT) -o $(WORK_DIR).$(TOP_LEVEL) $(LIBRARY).$(TOP_LEVEL)

# ğŸ”¹ Dump'tan PASS ve FAIL Adreslerini Ã‡Ä±kar
extract:
	python3 $(DUMP_PARSER) $(DUMP_FILE) > /dev/null 2>&1  # ğŸ”¥ Sessiz modda Ã§alÄ±ÅŸtÄ±r

# ğŸ”¹ Test Sonucunu Kontrol Et
check: extract
	python3 $(CHECK_SCRIPT) $(PASS_FAIL_ADDR) $(FETCH_LOG) > /dev/null 2>&1  # ğŸ”¥ Sessiz modda Ã§alÄ±ÅŸtÄ±r

# ğŸ”¹ GeÃ§ici DosyalarÄ± Temizle
clean:
	rm -rf $(WORK_DIR)
	rm -f transcript vsim.wlf modelsim.ini test_results.txt fetch_log.txt pass_fail_addr.txt sim_log.txt
